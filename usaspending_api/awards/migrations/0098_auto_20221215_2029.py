# Generated by Django 3.2.15 on 2022-12-15 20:29

from django.db import migrations, models
import django.db.models.deletion

from usaspending_api.awards.models.award import vw_awards_sql
from usaspending_api.common.matview_manager import OVERLAY_VIEWS
from django.core.management import call_command


def rebuild_mv_agency_autocomplete(apps, schema_editor):
    call_command('matview_runner', '--only', 'mv_agency_autocomplete')


class Migration(migrations.Migration):

    dependencies = [
        ('search', '0020_auto_20221215_2029'),
        ('awards', '0097_transaction_views'),
    ]

    operations = [
        migrations.AlterModelOptions(
            name='award',
            options={'managed': False},
        ),
        migrations.AlterField(
            model_name='financialaccountsbyawards',
            name='award',
            field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.CASCADE, related_name='financial_set', to='search.awardsearch'),
        ),
        migrations.AlterField(
            model_name='parentaward',
            name='award',
            field=models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, primary_key=True, serialize=False, to='search.awardsearch'),
        ),
        migrations.RunSQL(
            sql=vw_awards_sql,
            reverse_sql="DROP VIEW IF EXISTS vw_awards",
            # Without this, Django will try to actually change the old table names in another migration
            # This says we've already done it.
            state_operations=[
                migrations.AlterModelTable(
                    name='award',
                    table='vw_awards',
                )
            ]
        ),
        # Drop the dependent views
        migrations.RunSQL(
            sql="DROP MATERIALIZED VIEW IF EXISTS mv_agency_autocomplete",
            reverse_sql="",
        ),
        migrations.RunSQL(
            sql="DROP VIEW IF EXISTS vw_es_award_search",
            reverse_sql="",
        ),
        # Recreate the dependent views
        migrations.RunPython(
            code=rebuild_mv_agency_autocomplete,
            reverse_code=None,
        ),
        migrations.RunSQL(
            sql=OVERLAY_VIEWS[0].read_text(),
            reverse_sql="",
        ),
        migrations.AlterModelOptions(
            name='award',
            options={'managed': False},
        ),
        migrations.RunSQL(
            sql="DROP TABLE IF EXISTS awards",
            reverse_sql="",
        ),
    ]
